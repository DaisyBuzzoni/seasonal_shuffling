---
title: "Buzzoni D., Cunning R. and Baker A. C. (2023) Initial Algal Symbiont Communities Affect Shuffling to Durusdinium after Coral Bleaching and Reflect Seasonal Differences in Bleaching Sensitivity"
output:
  html_document: default
  pdf_document: default
---
```{r, echo=F, warning=FALSE,message=FALSE}
library(plyr)
library(stringr)
library(reshape2)
library(dplyr)
library(steponeR)
library(ggplot2)
library(ggforce)
library(scales)
library(lme4)
library(lmerTest)
library(lsmeans)
library(lattice)
library(metafor)
library(shiny)
library(leaflet)
library(ggtext)
library(emmeans)
library(multcompView)
library(grid)
library(ggsci)
library(nlme)
library(MASS)
library(effects)
library(png)
library(ggrepel)
library(redres)
library(tidyr)
library(plotrix)
```

```{r, echo=F}
#data file per species per batch (batches 'S' and 'W')
Sofav_wide=read.csv('ofav_wide.csv')
Sssid_wide=read.csv('ssid_wide.csv')
Smcav_wide=read.csv('mcav_wide.csv')
Wofav_wide=read.csv('Wofav_wide.csv')
Wssid_wide=read.csv('Wssid_wide.csv')
Wmcav_wide=read.csv('Wmcav_wide.csv')
ofav_wide_batches=rbind(Sofav_wide,Wofav_wide)
ssid_wide_batches=rbind(Sssid_wide,Wssid_wide)
mcav_wide_batches=rbind(Smcav_wide,Wmcav_wide)
batches=rbind(ofav_wide_batches,ssid_wide_batches,mcav_wide_batches)
batches$Batch=factor(batches$Batch,levels=c('April','October'))
batches$Species=factor(batches$Species,levels=c('M.cavernosa','O.faveolata', 'S.siderea'))
batches$Treatment=factor(batches$Treatment,levels=c('Manipulated','Control'))
batches$Colony=as.factor(batches$Colony)
```

## SEASONAL TEMPERATURES
### Figure 1a: Temperatures are seasonal
```{r,warning=FALSE,message=FALSE}
temp3=read.csv("foweytemps5yrs.csv")
temp3$date=as.Date(with(temp3, paste('2019',MM, DD,sep="-")), "%Y-%m-%d")
 temp3$WTMP=as.numeric(paste(temp3$WTMP))
 temp=read.csv("temp.csv")
temp$Date=as.Date(temp$Date,format = "%d/%m/%Y")
 
 ggplot()+stat_summary(data=temp3,aes(x=date,y=WTMP,fill='darkgreen'),fun.data=mean_se,geom='ribbon',alpha=0.6)+theme_minimal(base_size = 15)%+replace%
    theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
          panel.grid.major.x = element_blank())+
   labs(x='Month (2019-20)',y='Temperature/°C')+stat_summary(data=temp,aes(x=Date,y=Temp,fill='chartreuse2'),fun.data=mean_se,geom='ribbon',alpha=0.6)+scale_fill_identity(guide='legend',breaks=c('darkgreen','chartreuse2'),labels=c('Fowey Rock 2015-19 average','Emerald Reef 2019'))+guides(fill=guide_legend(title=''))+theme(legend.position = c(0.6,0.3))+scale_x_date(date_labels = '%b',limits=as.Date(c('2019-01-01','2019-12-31')))
#ggsave('1a.seasonal_temps.pdf',device='pdf', width=7,height=5) #add labels to figure to show two collection timepoints
```

## INITIAL SYMBIONT COMMUNITIES

### Figure 1b: M. cavernosa symbionts per host cell increased from April to October and S. siderea symbionts decreased- changes dependent on dominant symbiont in O. faveolata and S. siderea

Add arrows to show that points above line show higher in april, below line shows higher in April.

```{r,warning=F,message=F}

#calculate seasonal per colony change in symbiont density (ie the average symbiont density between the two cores taken from each colony per batch)
batches$pre_sh[which(batches$pre_sh==0)]=NA
Apr_Oct_sh<-batches[,-c(2,3,7,8,10)]
Apr_Oct_sh<-filter(Apr_Oct_sh,Apr_Oct_sh$pre_sh!='NA')
Apr_Oct_sh= Apr_Oct_sh %>%
  group_by(Species,Colony,Batch) %>%
  summarise_at(vars(pre_sh, pre_propD, preDcat), funs(mean(., na.rm=TRUE))) #must average the S:H and prop Durusdinium between colony replicates in order to calculate % change between April and October
#Apr_Oct_sh<-Apr_Oct_sh[-c(5),] #remove colony 28 as no April data
#remove colonies with mixed communities (less than 98% dominant) to examine effect of symbiont genus on seasonal S:H
#Apr_Oct_sh<-Apr_Oct_sh[-c(21,22,31,32,39,40,41,42,45,46,49,50,55,56),]
#Apr_Oct_sh<-Apr_Oct_sh[,-c(5)]
#Apr_Oct_sh$preDcat<-as.character((Apr_Oct_sh$preDcat))
#Apr_Oct_sh$preDcat<-revalue(Apr_Oct_sh$preDcat,c('1'='D','0.99'='D','0.98'='D'))
#Apr_Oct_sh$sym<-c(rep('C',18),rep('B',10),rep('D',4),rep('B',2),rep('D',2),rep('C',4),rep('D',2))
#Apr_Oct_sh<-Apr_Oct_sh[,-c(5)]
#Apr_Oct_sh<- Apr_Oct_sh %>%
#  group_by(Colony)%>%
#  spread(Batch, pre_sh)
#Apr_Oct_sh$rel_change<-(log10(Apr_Oct_sh$October/Apr_Oct_sh$April))

#ggplot(data=Apr_Oct_sh)+
#  geom_point(aes(y=rel_change,x=Species, colour=sym))

Apr_Oct_sh<-Apr_Oct_sh[,-c(6)]
Apr_sh= filter(Apr_Oct_sh, Batch=='April')
Apr_sh$Apr_pre_sh=paste(Apr_sh$pre_sh)
Oct_sh= filter(Apr_Oct_sh, Batch=='October')
Oct_sh$Oct_pre_sh=paste(Oct_sh$pre_sh)
Apr_sh$Apr_pre_propd<-paste(Apr_sh$pre_propD)
Oct_sh$Oct_pre_propd<-paste(Oct_sh$pre_propD)
Apr_sh<-Apr_sh[,-c(3,4,5)]
Oct_sh<-Oct_sh[,-c(3,4,5)]
Apr_Oct_sh_change=join(Apr_sh,Oct_sh,by='Colony')
Apr_Oct_sh_change=Apr_Oct_sh_change[,-c(5)]
Apr_Oct_sh_change$Apr_pre_sh=as.numeric(Apr_Oct_sh_change$Apr_pre_sh)
Apr_Oct_sh_change$Oct_pre_sh=as.numeric(Apr_Oct_sh_change$Oct_pre_sh)
Apr_Oct_sh_change$pre_sh_change= Apr_Oct_sh_change$Oct_pre_sh- Apr_Oct_sh_change$Apr_pre_sh
Apr_Oct_sh_change$rel_sh_change= ((Apr_Oct_sh_change$Oct_pre_sh- Apr_Oct_sh_change$Apr_pre_sh)/Apr_Oct_sh_change$Apr_pre_sh)
Apr_Oct_sh_change$octtoapr<- Apr_Oct_sh_change$Oct_pre_sh/Apr_Oct_sh_change$Apr_pre_sh
Apr_Oct_sh_change$meanpropd<-(as.numeric(Apr_Oct_sh_change$Apr_pre_propd) + as.numeric(Apr_Oct_sh_change$Oct_pre_propd))/2
Apr_Oct_sh_change$propD_group<-paste(Apr_Oct_sh_change$meanpropd)
Apr_Oct_sh_change$propD_group<-c(rep('0',10),rep('mixed',1),rep('0',4),rep('mixed',1),rep('1',2),rep('0',1),rep('mixed',2),rep('1',1),rep('mixed',1),rep('0',1),rep('mixed',1),rep('0',1),rep('1',2))
Apr_Oct_sh_change$propD_group<-factor(Apr_Oct_sh_change$propD_group,levels=c('0','mixed','1'))
#Apr_Oct_sh_change$Species...1=factor(Apr_Oct_sh_change$Colony)
# this dataframe shows the average change in s:h per colony


##test statistical significance in seasonal change in S:H
#hist(log10(batches$pre_sh)) #log10 transformed data then used linear mixed effects model on s:h data to test effect of batch within each species, with colony as a random factor

batches$transf_presh= log10(batches$pre_sh) # transform the response variable

mcavpreshmod=lmer(log10(pre_sh)~Batch+pre_propD+(1|Colony),data=filter(batches,batches$Species=='M.cavernosa'))
plot_resqq(mcavpreshmod) # check residuals are normally distributed

mcavpreshmod2<- as_lmerModLmerTest(mcavpreshmod)
summary(mcavpreshmod2) #p for batch, p=0.001126** p for batch=0.000777* when pre_propD added 

# now let's get the batch parameter estimates and CIs:
mcavemm.sh<- emmeans(mcavpreshmod, specs=revpairwise~Batch) 
summary(mcavemm.sh)
mcavemmsh_contrasts<- mcavemm.sh$contrasts %>%
     confint()%>%
     as.data.frame() # NB these results are given on a log10 scale, giving the odds ratio of October to April S:H

mcavemm.sh2<- emmeans(mcavpreshmod, specs=revpairwise~Batch, type='response') 
summary(mcavemm.sh2) #alternatively, by backtransforming the predicted means for each batch, we can then calculate the percentage change, which may be more intuitive to interpret.
mcavemmsh_pred<-as.data.frame(mcavemm.sh2$emmeans)

mcavemmsh_pred$relchange<- (mcavemmsh_pred[2,2]-mcavemmsh_pred[1,2])/mcavemmsh_pred[1,2]
mcavemmsh_pred$relupper<- (mcavemmsh_pred[2,6]-mcavemmsh_pred[1,5])/mcavemmsh_pred[1,2]
mcavemmsh_pred$rellower<- (mcavemmsh_pred[2,5]-mcavemmsh_pred[1,6])/mcavemmsh_pred[1,2]


ofavpreshmod=lmer(log10(pre_sh)~Batch*pre_propD+(1|Colony),data=filter(batches,batches$Species=='O.faveolata'))
plot_resqq(ofavpreshmod) # check residuals are normally distributed
ofavpreshmod2<- as_lmerModLmerTest(ofavpreshmod)
summary(ofavpreshmod2) #p for batch, p=0.938, 0.7838 when pre propd added. pre prop d had significant effect, 0.0118.
#when pre propd included as interaction with batch, effect of batch was 0.28375, insignificant interaction between batch and pre prop d (0.17855),but significant effect of pre prop d on pre SH (0.00433). 

#now test for seasonal change in proportion d*S:H
ofavpredshmod<-lmer((log10(pre_sh)*pre_propD)~Batch+(1|Colony),data=filter(batches,batches$Species=='O.faveolata'))
plot_resqq(ofavpredshmod) # check residuals are normally distributed
ofavpredshmod2<- as_lmerModLmerTest(ofavpredshmod)
summary(ofavpredshmod2)

ggplot(data=filter(batches,batches$Species=='O.faveolata'), aes(y=log10(pre_sh), x=pre_propD, colour=Batch))+
  geom_point()

ggplot(data=filter(batches,batches$Species=='S.siderea'), aes(y=log10(pre_sh), x=pre_propD, colour=Batch))+
  geom_point()

ggplot(data=filter(batches,batches$Species=='M.cavernosa'), aes(y=log10(pre_sh), x=Batch, colour=Batch))+
  geom_point()

# now let's get the batch parameter estimates and CIs:
ofavemm.sh<- emmeans(ofavpreshmod, specs=revpairwise~Batch) 
summary(ofavemm.sh)
ofavemmsh_contrasts<- ofavemm.sh$contrasts %>%
     confint()%>%
     as.data.frame() # NB these results are given on a log10 scale

ofavemm.sh2<- emmeans(ofavpreshmod, specs=revpairwise~Batch, type='response') 
summary(ofavemm.sh2) #alternatively, by backtransforming the predicted means for each batch, we can then calculate the percentage change, which may be more intuitive to interpret.
ofavemmsh_pred<-as.data.frame(ofavemm.sh2$emmeans)

ofavemmsh_pred$relchange<- (ofavemmsh_pred[2,2]-ofavemmsh_pred[1,2])/ofavemmsh_pred[1,2]
ofavemmsh_pred$relupper<- (ofavemmsh_pred[2,6]-ofavemmsh_pred[1,5])/ofavemmsh_pred[1,2]
ofavemmsh_pred$rellower<- (ofavemmsh_pred[2,5]-ofavemmsh_pred[1,6])/ofavemmsh_pred[1,2]


ssidpreshmod=lmer(log10(pre_sh)~Batch*pre_propD+(1|Colony),data=filter(batches,batches$Species=='S.siderea'))
#plot_resqq(mcavpreshmod) # check residuals are normally distributed
ssidpreshmod2<- as_lmerModLmerTest(ssidpreshmod)
summary(ssidpreshmod2) #p for batch, p=0.04833*, p=0.0315 when model includes pre propD. interaction between pre propd and batch on pre sh is significant (0.005007) and effect of batch on pre sh also becomes more significant with interaction included, p=0.000464. 
# now let's get the batch parameter estimates and CIs:
ssidemm.sh<- emmeans(ssidpreshmod, specs=revpairwise~Batch) 
summary(ssidemm.sh)

ssidcladpresh<-filter(batches, batches$Species=='S.siderea')
ssidcladpresh<-filter(ssidcladpresh, ssidcladpresh$preDcat<0.05)
ssidcladpreshmod<-lmer(log10(pre_sh)~Batch+(1|Colony), data=ssidcladpresh)
ssidcladpreshmod2<- as_lmerModLmerTest(ssidcladpreshmod)
summary(ssidcladpreshmod2)
ssiddurpresh<-filter(batches, batches$Species=='S.siderea')
ssiddurpresh<-filter(ssiddurpresh, ssiddurpresh$preDcat>0.95)
ssiddurpreshmod<-lmer(log10(pre_sh)~Batch+(1|Colony), data=ssiddurpresh)
ssiddurpreshmod2<- as_lmerModLmerTest(ssiddurpreshmod)
summary(ssiddurpreshmod2)


#again, checking for sh*propd interaction
ssidpredshmod=lmer((log10(pre_sh)*pre_propD)~Batch+(1|Colony),data=filter(batches,batches$Species=='S.siderea'))
#plot_resqq(mcavpreshmod) # check residuals are normally distributed
ssidpredshmod2<- as_lmerModLmerTest(ssidpredshmod)
summary(ssidpredshmod2)

ssidemmsh_contrasts<- ssidemm.sh$contrasts %>%
     confint()%>%
     as.data.frame() # NB these results are given on a log10 scale

ssidemm.sh2<- emmeans(ssidpreshmod, specs=revpairwise~Batch, type='response') 
summary(ssidemm.sh2) #alternatively, by backtransforming the predicted means for each batch, we can then calculate the percentage change, which may be more intuitive to interpret. However, this is misleading since it is the differnece of the averages, not the average difference. 
ssidemmsh_pred<-as.data.frame(ssidemm.sh2$emmeans)

ssidemmsh_pred$relchange<- (ssidemmsh_pred[2,2]-ssidemmsh_pred[1,2])/ssidemmsh_pred[1,2]
ssidemmsh_pred$relupper<- (ssidemmsh_pred[2,6]-ssidemmsh_pred[1,5])/ssidemmsh_pred[1,2]
ssidemmsh_pred$rellower<- (ssidemmsh_pred[2,5]-ssidemmsh_pred[1,6])/ssidemmsh_pred[1,2]

#collate the dataframe for the log10 transformed contrast ratios
sh_emmcontrasts<-rbind(mcavemmsh_contrasts,ofavemmsh_contrasts,ssidemmsh_contrasts)
sh_emmcontrasts$Species<-c('M.cavernosa','O.faveolata','S.siderea')
sh_emmcontrasts$Species<-as.factor(sh_emmcontrasts$Species)
sh_emmcontrasts$change_untransformed= 10^(sh_emmcontrasts$estimate)
sh_emmcontrasts$lowerCI_change_untransformed= 10^(sh_emmcontrasts$lower.CL)
sh_emmcontrasts$upperCI_change_untransformed= 10^(sh_emmcontrasts$upper.CL) #these ratios of oct:apr are now backtransformed and ready to be plotted 

#for the alternative plot, collate the calculated relative changes
sh_emmpredchange<-rbind(mcavemmsh_pred[1,],ofavemmsh_pred[1,],ssidemmsh_pred[1,])
sh_emmpredchange$Species<-c('M.cavernosa','O.faveolata','S.siderea')
sh_emmpredchange$Species<- as.factor(sh_emmpredchange$Species)


#plot set-up
ofav=expression(paste(italic("O. faveolata")))
ssid=expression(paste(italic("S. siderea")))
mcav=expression(paste(italic("M. cavernosa")))


ggplot()+
  geom_point(data=sh_emmcontrasts, aes(x=Species,y=(estimate)), size=3, alpha=0.6)+ #large points are showing estimated october:april 
  geom_point(data=Apr_Oct_sh_change, aes(x=Species...1,y=log10(octtoapr), colour=propD_group), size=1.2,  position=position_jitter(width=0.1))+ #small points are showing october s:h / april s:h
  geom_errorbar(data=sh_emmcontrasts, aes(x=Species, ymin=(lower.CL), ymax=(upper.CL)), size=0.5, width=0.2, alpha=0.6)+
  theme_minimal(base_size = 15)%+replace%
    theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank()
        )+
  labs(y='log(October : April symbionts per host cell)', x='')+
   scale_x_discrete(labels=c(mcav,ofav,ssid), expand=expansion(add=c(0.4,1.2)))+
  scale_color_manual(values=c('blue','grey','red'), name='Proportion Durusdinium')+
  geom_hline(yintercept=0,linetype='dashed')+
  scale_y_continuous(breaks=seq(-1,1.5,0.5))+
theme(legend.title = element_markdown(size=11), legend.text=element_text(size=11),legend.position = c(0.6,0.9))+
  guides(colour=guide_legend(ncol=3))
#ggsave('1b.seasonal_initialSH.pdf',device='pdf',width=7,height=5) # add 'higher in Oct'/'higher in Apr' labels to figure
 scale_color_manual(values=c('deeppink2','darkorange1', 'darkturquoise'))+
   guides(colour=F)+
```

### Figure 1c: Proportion Durusdinium did not change between April and October for any of the 3 coral species. 

```{r,warning=F,message=F}

batch_comparevi=
ggplot()+
   theme_minimal(base_size = 15)%+replace%
    theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank())+ 
  labs(y='Initial proportion *Durusdinium*')+
  scale_fill_manual(values=c('#3C5488B2','#00A087B2'),labels=c('April','October'))+
  geom_violin(data=batches,aes(x=Species,y=pre_propD,colour=Batch),scale = 'width')+
  geom_dotplot(data=batches,bins=30,binaxis='y',dotsize=0.5,stackratio=0.8,stackdir='center',stackgroups=F, position='dodge',alpha=0.7,aes(x= Species,y=pre_propD,fill=Batch, colour=Batch))+
  scale_colour_manual(values=c('#3C5488B2','#00A087B2'),labels=c('April','October'))+
  scale_x_discrete(labels=c(mcav,ofav,ssid))+
   theme(axis.title.y.left  = element_markdown(), legend.position = c(0.2,0.5))+
  labs(x='')+
  theme(legend.title = element_text(size=0), legend.key.size = unit(0.6,'cm'))
batch_comparevi
#ggsave('1c. batchcompare_propd_vi_dot.pdf',device='pdf',width=7,height=5)

#hist(batches$pre_propD)

mcavpredmod=glmer(pre_propD~Batch+(1|Colony),data=filter(batches,batches$Species=='M.cavernosa'), family = 'binomial')
summary(mcavpredmod) # p=1

ofavpredmod=glmer(pre_propD~Batch+(1|Colony),data=filter(batches,batches$Species=='O.faveolata'), family = 'binomial')
summary(ofavpredmod) # p=0.2

ssidpredmod=glmer(pre_propD~Batch+(1|Colony),data=filter(batches,batches$Species=='S.siderea'), family = 'binomial')
summary(ssidpredmod)# p0.09

#Make it clear that this plot is showing raw data, not predictive model. glmer is now 'family binomial'. 
```

## BLEACHING SENSITIVITY
```{r,echo=F,warning=F,message=F,fig.show='hide'}
bleaching_tidy=read.csv('bleaching_tidy_dates.csv')
blch_sensitivity=dplyr::filter(bleaching_tidy,Treatment=='Bleached')
blch_sensitivity=subset(blch_sensitivity,select=c(1,3,4,6,8,10,11,15,17))
sensitivity_pre=dplyr::filter(blch_sensitivity, Timepoint=='Pre-bleach')
sensitivity_pre$pre_sh=paste(sensitivity_pre$Sym.Host)
sensitivity_pre$pre_y2=paste(sensitivity_pre$Y2)
sensitivity_pre$pre_propd=paste(sensitivity_pre$PropD)
sensitivity_pre=subset(sensitivity_pre,select=-c(3,4,5,6))
sensitivity_post=dplyr::filter(blch_sensitivity, Timepoint=='Post-bleach')
sensitivity_post$post_sh=paste(sensitivity_post$Sym.Host)
sensitivity_post$post_y2=paste(sensitivity_post$Y2)
sensitivity_post$post_propd=paste(sensitivity_post$PropD)
sensitivity_post=subset(sensitivity_post,select=c(2,10,11,12))
blch_sensitivity=plyr::join(sensitivity_pre,sensitivity_post,by='Core')
blch_sensitivity$pre_sh=as.numeric(blch_sensitivity$pre_sh)
blch_sensitivity$post_sh=as.numeric(blch_sensitivity$post_sh)
blch_sensitivity$pre_y2=as.numeric(blch_sensitivity$pre_y2)
blch_sensitivity$post_y2=as.numeric(blch_sensitivity$post_y2)
blch_sensitivity$rel_drop_sh= ((blch_sensitivity$post_sh - blch_sensitivity$pre_sh)/blch_sensitivity$pre_sh)*100
blch_sensitivity$change_sh=(blch_sensitivity$post_sh - blch_sensitivity$pre_sh)
blch_sensitivity$change_y2=(blch_sensitivity$post_y2 - blch_sensitivity$pre_y2)
blch_sensitivity$rel_drop_y2= ((blch_sensitivity$post_y2 - blch_sensitivity$pre_y2)/blch_sensitivity$pre_y2)*100
blch_sensitivity$Species=factor(blch_sensitivity$Species,levels=c('M.cavernosa','O.faveolata','S.siderea'))
blch_sensitivity$Batch=factor(blch_sensitivity$Batch, levels=c('1','2'))
blch_sensitivity$InitialDom=revalue(blch_sensitivity$InitialDom,c('D'='d','B'='nond','C'='nond'))
blch_sensitivity$InitialDom=factor(blch_sensitivity$InitialDom,levels=c('d','nond'))
blch_sensitivity=filter(blch_sensitivity, InitialDom=='d'| InitialDom=='nond')
blch_sensitivity$Colony=as.factor(blch_sensitivity$Colony) 
```

### M. cavernosa showed higher sensitivity to bleaching in October compared to April.

```{r, message=F, warning=F}
blch_sensitivity=blch_sensitivity[-c(56,57,75),] #remove 're'_drop_sh' NAs
mcavsensitivity=subset(blch_sensitivity,Species=='M.cavernosa')

mcavblchresmod=glmer(post_sh~Batch+(1|Colony),data=mcavsensitivity)
#plot_resqq(mcavblchresmod)
summary(mcavblchresmod)
mcavblchresmod2<- as_lmerModLmerTest(mcavblchresmod)
summary(mcavblchresmod2)#the effect of batch on post heat stress sh is significant (p=0.002206).

mcavinity2mod=glmer(pre_sh~Batch+(1|Colony),data=mcavsensitivity)
summary(mcavinity2mod)
mcavinity2mod2<- as_lmerModLmerTest(mcavinity2mod)
summary(mcavinity2mod2) #the effect of batch on pre heat stress Fv/Fm was not significant (p=0.216)


ofavsensitivity<-subset(blch_sensitivity,Species=='O.faveolata')
ofavblchresmod=glmer(post_sh~Batch+InitialDom+(1|Colony),data=ofavsensitivity)
#plot_resqq(ofavblchresmod)
summary(ofavblchresmod)
ofavblchresmod2<- as_lmerModLmerTest(ofavblchresmod)
summary(ofavblchresmod2) #when separated by symbiont genus, the effect of batch on post heat stress sh is insignificant (p=0.680)

ssidsensitivity<-subset(blch_sensitivity,Species=='S.siderea')
ssidblchresmod=glmer(post_sh~Batch+InitialDom+(1|Colony),data=ssidsensitivity)
#plot_resqq(ssidblchresmod)
summary(ssidblchresmod)
ssidblchresmod2<- as_lmerModLmerTest(ssidblchresmod)
summary(ssidblchresmod2) #when separated by symbiont genus, the effect of batch on post heat stress s:h is insignificant (p=0.258)

mcavsensitivity$predicted<- predict(mcavblchresmod)
mcavsensitivity$residuals<- residuals(mcavblchresmod)
mcavsensitivityse<-mcavsensitivity %>%
  group_by(Batch) %>%
  summarise(se=std.error(post_sh))
as.data.frame(mcavsensitivityse)
mcavsensitivitysumm<-mcavsensitivity %>%
  group_by(Batch) %>%
  summarise(mean=mean(post_sh))
as.data.frame(mcavsensitivitysumm)
mcavsensitivitysumm$se<-mcavsensitivityse$se
mcavsensitivitysey2<-mcavsensitivity %>%
  group_by(Batch) %>%
  summarise(sey2=std.error(post_y2))
as.data.frame(mcavsensitivitysey2)
mcavsensitivitymeany2<-mcavsensitivity %>%
  group_by(Batch) %>%
  summarise(meany2=mean(post_y2))
as.data.frame(mcavsensitivitymeany2)
mcavsensitivitysumm$sey2<-mcavsensitivitysey2$sey2
mcavsensitivitysumm$meany2<-mcavsensitivitymeany2$meany2

ggplot()+
  geom_point(data=mcavsensitivity,aes(x=post_y2,y=post_sh,colour=Batch), size=1.5)+
  geom_errorbar(data=mcavsensitivitysumm, aes(x=meany2,ymin=mean-se,ymax=mean+se, colour=Batch), width=0.01, show.legend=F)+
   geom_errorbar(data=mcavsensitivitysumm, aes(y=mean,xmin=meany2-sey2,xmax=meany2+sey2, colour=Batch), width=0.0025, show.legend=F)+
  geom_point(data=mcavsensitivitysumm, aes(x=meany2,y=mean,colour=Batch),size=3, show.legend=F)+
  theme_minimal(base_size = 15)%+replace%
    theme(panel.border = element_rect(colour='grey20',size=0.5,fill=NA))+
   scale_colour_manual(values=c('#3C5488B2','#00A087B2'),labels=c('April','October'))+
 theme(panel.spacing = unit(1.2, "lines"),legend.position = 'right')+
  theme(legend.title=element_text(size=0), axis.title.y = element_markdown(), axis.title.x=element_markdown())+
theme(legend.position = c(0.8,0.5))+
  labs(x='F<sub>v</sub>/F<sub>m</sub> after heat stress',y='Symbionts per *M. cavernosa* <br> cell after heat stress')

  #ggsave('1d.seasonal_bleaching_sensitivity.pdf',device='pdf',width=7,height=5)
```


```{r,echo=F}
ofav_DHW=read.csv('ofav_bleaching_DHW.csv')
ssid_DHW=read.csv('ssid_bleaching_DHW.csv')
mcav_DHW=read.csv('mcav_bleaching_DHW.csv')
ofav_recov=read.csv('ofav_recov_days.csv')
ssid_recov=read.csv('ssid_recov_days.csv')
mcav_recov=read.csv('mcav_recov_days.csv')
ofav=expression(paste(italic("O. faveolata")))
ssid=expression(paste(italic("S. siderea")))
mcav=expression(paste(italic("M. cavernosa"))) 
```


```{r, warning=F, message=F, include=F}
allbleach=rbind(ofav_DHW,ssid_DHW,mcav_DHW)
allbleach$Species=factor(allbleach$Species,levels=c('M.cavernosa','O.faveolata','S.siderea'))
allrecov=rbind(mcav_recov, ofav_recov, ssid_recov)
allrecov$Species=factor(allrecov$Species,levels=c('M.cavernosa','O.faveolata','S.siderea'))
allrecov$InitialDom=revalue(allrecov$InitialDom,c('D'='d','B'='nond','C'='nond'))
allrecov$InitialDom=factor(allrecov$InitialDom)
allbleach$InitialDom=revalue(allbleach$InitialDom,c('D'='d','B'='nond','C'='nond'))
allbleach$InitialDom=factor(allbleach$InitialDom)
allbleach$Batch=factor(allbleach$Batch)
allrecov$Batch=factor(allrecov$Batch)
allbleach$Colony=factor(allbleach$Colony)
allrecov$Colony=factor(allrecov$Colony)


allbleach<-allbleach[-c(167),] 
allrecov<-allrecov[-c(86,239),]#model highlighted this one datapoint as an outlier in both dataframes
  

bleachingmod2<-glmer(Shprop~DHW*Species*InitialDom+(1|Colony), data=allbleach)
#plot_resqq(bleachingmod2) #perform statistical tests on mixed effects model
bleachingmod3<-as_lmerModLmerTest(bleachingmod2)
  summary(bleachingmod3)
  anova(bleachingmod3)#no significant difference in bleaching (DHW interaction with species) between species p=0.818834, but a significant interaction between DHW and initial symbiont type (p=0.00421), with nond-hosting corals bleaching more. 
  
#now looking at any batch differences within each coral species:
  mcavbleachingmod<-glmer(Shprop~DHW*Batch+(1|Colony), data=filter(allbleach,allbleach$Species=='M.cavernosa'))
  #plot_resqq(mcavbleachingmod)
  mcavbleachingmod2<-as_lmerModLmerTest(mcavbleachingmod)
  summary(mcavbleachingmod2)
  anova(mcavbleachingmod2) #significant interaction between DHW and batch on proportion of symbionts retained, p=2.21e-06, with the october batch losing more.
  
  
recovmod<-glm(Shprop~Recov.Days*Species*InitialDom, data=allrecov, family='quasipoisson')
#plot(recovmod)
recoveryfit= with(summary(recovmod), 1 - deviance/null.deviance)
recoveryfit #0.5469, R^2 for plotted quasipoisson model (without batch)

recovmod2<-glmer(Shprop~Recov.Days*Species*InitialDom+(1|Colony), data=allrecov)
#plot_resqq(recovmod2)
recovmod3<-as_lmerModLmerTest(recovmod2)
summary(recovmod3)
anova(recovmod3)# symbiont recovery was significantly differnet between species (recovery days * symbiont density interaction), with ofav p=0.00556 and ssid p=6.48e-06 recovering more than mcav for a given amount of recovery (likely indicative of the delay in symbiont recovery seen in mcav). There was also a significant interaction between initial symbiont genus and recovery days p=2.00e-05, with corals initially not hosting Durusdinium recovering more with a given amount of recovery. 

    mcavrecovmod<-glmer(Shprop~Recov.Days*Batch+(1|Colony), data=filter(allrecov,allrecov$Species=='M.cavernosa'))
  #plot_resqq(mcavrecovmod)
  mcavrecovmod2<-as_lmerModLmerTest(mcavrecovmod)
  summary(mcavrecovmod2)
  anova(mcavrecovmod2) #there was a significant interaction p=0.004611 of batch on the relationship between symbiont density and recovery days, with the October batch recovering less.
  
  Spec.labs=c('M. cavernosa','O. faveolata','S. siderea')
names(Spec.labs)=c('M.cavernosa','O.faveolata','S.siderea')

```


## SHUFFLING
### Figure 2: Inter- and intra-species variation in the shuffling towards durusdinium after recovery from heat stress.
Comparison of Proportion D before start of heat stress compared to two months into recovery. Data are binned at intervals of 0.02 (for variable Proportion D), and size aesthetic relates to number of cores in each bin to reduce overplotting. Data from April and October are both included here.

```{r,warning=F}
mcavshift<-filter(mcav_wide_batches,!is.na(postDcat),!is.na(preDcat))
ofavshift<-filter(ofav_wide_batches,!is.na(postDcat),!is.na(preDcat))
ssidshift<-filter(ssid_wide_batches,!is.na(postDcat),!is.na(preDcat))
beforeaftershift<-rbind(mcavshift,ofavshift,ssidshift)
beforeaftershift$Treatment<-factor(beforeaftershift$Treatment,levels=c('Manipulated','Control'))
gaindd=expression(paste("Gained",italic(" Durusdinium")))
lostd=expression(paste("Lost",italic(" Durusdinium")))
my_y_title <- expression(paste("Proportion ", italic("Durusdinium"), " after"))
my_x_title<- expression(paste("Proportion ", italic("Durusdinium"), " before"))

   ggplot()+geom_count(data=(beforeaftershift),
     aes(x=preDcat,y=postDcat,colour=Treatment, alpha=0.6))+
facet_grid(cols=vars(Species),labeller=labeller(Species=Spec.labs))+
geom_abline(slope=1,intercept = 0,linetype='dotted')+
  scale_color_manual(values=c('brown2','blue3'),labels=c('Bleached','Control'))+
  theme_minimal(base_size = 15)%+replace%
    theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank())+
  labs(x=my_x_title,y=my_y_title)+
 guides(size=guide_legend(title='Binned n'))+
  scale_size(range=c(1,14),breaks=(c(1,2,6,10)))+
  theme(strip.text.x = element_text(face = 'italic'),
      panel.spacing = unit(1.5, "lines"), legend.position = 'bottom', legend.title=element_text(size=12))+
      guides(colour = guide_legend(title=''))+
     guides(alpha=F)
#ggsave('2.before_after_durusdinium.pdf',device='pdf', width=10,height=5) #add 'gained durusdinium'/'lost durusdinium' labels

```

### Shuffling towards high proportions of Durusdinium after heat stress recovery was greatest in M. cavernosa, followed by O. faveolata, followed by S. siderea. 

Emulating the 'symbiont shuffling' plot to compare coral species, as in Cunning et al 2018 figure 3b. In order to be able to include mcav, which has no variation in initial proportion d, the following mcav models are independent of initial proportion d, then integrated in with the previous ofav & ssid predicted effects. 
```{r,message=F,warning=F}
shufflemod=glm(post_propD~pre_propD + Treatment*Species*Batch, data=filter(batches,batches$Species!='M.cavernosa'), family='quasibinomial')
#NB a mixed effects model cannot be used here, since a quasibinomial distribution is needed to bound this metric between -1 and 1. 

# have a look at the data to see data distribution for the change in proportion Durusdinium
ggplot(data=filter(batches,batches$Species!='M.cavernosa'),aes(y=post_propD, x=pre_propD))+
  geom_smooth(aes(colour=Species, linetype=Treatment), method='glm',method.args = list(family = "quasibinomial"), alpha=0.1)+
  geom_point(aes(colour=Species, shape=Treatment))+
  geom_abline(slope=1,intercept = 0,linetype='dotted')+
  theme_minimal()

summary(shufflemod)# Model summary
#treatment had significant effect on shuffling (p=0.0259). Batch did not significantly affect shuffling (p=0.8350).
                              
#Get fitted values averaging across initial proportion durusdinium
eff <- effect(c('pre_propD','Species','Treatment', 'Batch'), shufflemod, 
              xlevels=list(pre_propD=seq(0, 1, by=0.01)))
# Get all fitted values and subsets for each treatment
res <- droplevels(data.frame(eff))

res$Species <- factor(res$Species, levels=c("O.faveolata", "S.siderea"))
res.Bl <- subset(data.frame(eff), Treatment=="Manipulated")
res.Ct <- subset(data.frame(eff), Treatment=="Control")
# Get AUC for fitted values, lower and upper confidence limits
auc <- aggregate(res[, c("fit", "lower", "upper")], 
                 by=list(Species=res$Species, Treatment=res$Treatment), 
                 FUN=function(x) (mean(x)-0.5)/0.5)
                
auc.list <- split(auc, list(auc$Treatment))
auc$Treatment=factor(auc$Treatment, levels=c('Manipulated','Control'))
levels(auc$Treatment)<-c('Bleached','Control')
auc$Species=factor(auc$Species, levels=c('O.faveolata', 'S.siderea'))

```

```{r,warning=F,message=F}
#using model independent of initial prop d for mcav
shufflemod2=glm(post_propD ~Treatment*Batch,
                 data=subset(batches, batches$Species=='M.cavernosa'))
summary(shufflemod2)
#again for the initial durusdinium independent model, batch is not a significant driver of shuffling, p= 0.066.  This model did not fit a quasibinomial distrubution, but is almost entirely bond between 0 and 1 regardless due to very large effect size & minimal variation in the data. 

#ggplot(data=filter(batches,batches$Species=='M.cavernosa'),aes(y=post_propD, x=Treatment))+
  #geom_point(aes(shape=Treatment))+
 # theme_minimal()

eff2 <- effect(c('Treatment'), shufflemod2)

# Get all fitted values and subsets for each treatment level
res2 <- droplevels(data.frame(eff2))

res2.Bl <- subset(data.frame(eff2), Treatment=="Manipulated")
res2.Ct <- subset(data.frame(eff2), Treatment=="Control")
# Get AUC for fitted values, lower and upper confidence limits
auc2 <- aggregate(res2[, c("fit", "lower", "upper")], 
                 by=list(Treatment=res2$Treatment),
                 FUN=function(x) (mean(x)))
levels(auc2$Treatment)<-c('Bleached','Control')
auc2.list <- split(auc2, list(auc2$Treatment))
auc2$Species=factor(rep('M.cavernosa'))

speciesshuff<-rbind(auc,auc2)
speciesshuff$Species=factor(speciesshuff$Species, levels=c('M.cavernosa', 'O.faveolata', 'S.siderea'))

ggplot(data=speciesshuff)+
  geom_hline(yintercept=0,linetype='dashed')+
  geom_errorbar(aes(ymin=lower, ymax=upper, x=Species, colour=Species, group=Treatment),size=0.5, position=position_dodge(width=0.5), width=0.2)+
   geom_point(aes(y=fit, x=Species,shape=Treatment, colour=Species),size=2, position=position_dodge(width=0.5))+
  theme_minimal(base_size = 13)%+replace%
   theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
         panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
  scale_color_manual(values=c('deeppink2','darkorange1', 'darkturquoise'))+
  guides(colour=F, shape=guide_legend(title=''))+
  theme(legend.position=c(0.1,0.15))+
  labs(y='Symbiont Shuffling', x='')+
  scale_y_continuous(limits=c(-1,1.01),expand=c(0,0))+
   scale_x_discrete(labels=c(mcav,ofav,ssid), expand=expansion(mult=c(0.5,0.2)))

```

## Shuffling and photochemical efficiency
### Differnet photochemical disadvantages of hosting Durusdinium at ambient temperatures cannot explain the difference in shuffling between O. faveolata and S. siderea. 

Recreating Cunning et al 2018 test of the relative photochemical disadvantages of hosting durusdinium at ambient temperatures to explain species hierarchy (ofav>ssid) in shuffling.
```{r, warning=F}
ipam=filter(allbleach,allbleach$Timepoint=='Pre-bleach',allbleach$Species!='M.cavernosa')

ipaminitmod=lmer(Y2~PropD*Species*Batch+(1|Colony),data=ipam)
#plot_resqq(ipaminitmod)
summary(ipaminitmod)

#No significant differnece in the interaction between proportion durusdinium and coral species on Fv/Fm (p=0.255).
```

### Figure S1: Despite greater symbiont loss in the October M. cavernosa corals, shuffling between April and October were similar for all three coral species. 
```{r, warning=F}
#before getting fitted values, test statistical significance of batch for each species individually:
ofavbatchmod=glm(post_propD ~ pre_propD+Batch,
                 data=filter(batches, batches$Species=='O.faveolata', Treatment=='Manipulated'), family='quasibinomial')
ssidbatchmod=glm(post_propD ~ pre_propD+Batch,
                 data=filter(batches, batches$Species=='S.siderea', Treatment=='Manipulated'),family='quasibinomial')  
mcavbatchmod=lm(post_propD ~ Batch,
                 data=filter(batches, batches$Species=='M.cavernosa', Treatment=='Manipulated'))
summary(ofavbatchmod) #p=0.548
summary(ssidbatchmod) #p=0.3964
summary(mcavbatchmod) #p=0.0963



eff <- effect(c('pre_propD', 'Species','Treatment', 'Batch'), shufflemod, 
              xlevels=list(pre_propD=seq(0, 1, by=0.01)))
# Get all fitted values and subsets for each treatment and now also batch
res <- droplevels(data.frame(eff))

res$Species <- factor(res$Species, levels=c("O.faveolata", "S.siderea"))
res.Bl <- subset(data.frame(eff), Treatment=="Manipulated")
res.Ct <- subset(data.frame(eff), Treatment=="Control")
res.Ap<- subset(data.frame(eff), Batch=='April')
res.Oc<- subset(data.frame(eff), Batch=='October')
# Get AUC for fitted values, lower and upper confidence limits
auc <- aggregate(res[, c("fit", "lower", "upper")], 
                 by=list(Species=res$Species, Treatment=res$Treatment, Batch=res$Batch), 
                 FUN=function(x) (mean(x)-0.5)/0.5)

auc$Treatment=factor(auc$Treatment, levels=c('Manipulated','Control'))
levels(auc$Treatment)<-c('Bleached','Control')
auc$Species=factor(auc$Species, levels=c('O.faveolata', 'S.siderea'))
auc$Batch=factor(auc$Batch, levels=c('April','October'))



eff2 <- effect(c('Treatment','Batch'), shufflemod2)

res2 <- droplevels(data.frame(eff2))
res2.Bl <- subset(data.frame(eff2), Treatment=="Manipulated")
res2.Ct <- subset(data.frame(eff2), Treatment=="Control")
res2.Ap<- subset(data.frame(eff2), Batch=='April')
res2.Oc<- subset(data.frame(eff2), Batch=='October')

# Get AUC for fitted values, lower and upper confidence limits
auc2 <- aggregate(res2[, c("fit", "lower", "upper")], 
                 by=list(Treatment=res2$Treatment, Batch=res2$Batch),
                 FUN=function(x) (mean(x)))
levels(auc2$Treatment)<-c('Bleached','Control')
auc2$Species=factor(rep('M.cavernosa'))
auc2$upper[3]<-1
auc<-auc %>%
  relocate(Species, .after=upper)
batchshuff<- rbind(auc2, auc)
batchshuff$spbatch<- interaction (batchshuff$Batch,batchshuff$Species)

ggplot(data=batchshuff)+
  geom_errorbar(aes(ymin=lower, ymax=upper, x=Species, colour=Species, group=Batch, linetype=Treatment),size=0.5, position=position_dodge(width=0.5), width=0.2)+
   geom_point(aes(y=fit, x=Species, shape=Batch, colour=Species),size=2, position=position_dodge(width=0.5))+
  theme_minimal(base_size = 13)%+replace%
   theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
         panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
  scale_color_manual(values=c('deeppink2','darkorange1', 'darkturquoise'))+scale_x_discrete(labels=c(mcav,ofav,ssid))+
  guides(colour=F, shape=guide_legend(title=''), linetype=guide_legend(title=''))+
  theme(legend.position=c(0.19,0.3), legend.box= "horizontal")+
   geom_hline(yintercept = 0, lwd = 0.1) +
  labs(y='Symbiont Shuffling', x='')+
coord_cartesian(clip='on', ylim=c(-1,1), expand=T)
  scale_y_continuous(expand=c(0,0))
#ggsave('S1.shuffling_batches.pdf',device='pdf',width=7,height=5)
  
```

### Figure 3a: Shuffling occurred later in recovery in M. cavernosa compared to O. faveolata and S. siderea. 

```{r, warning=F}
shuffletimes=read.csv('shuffle_timepoints.csv',header =T)
shuffletimes$Treatment=factor(shuffletimes$Treatment)
shuff=read.csv('shuff.csv',header = T)
shuff$Colony=factor(shuff$Colony)
shuff$Species=factor(shuff$Species)
shuff$Timepoint=as.integer(shuff$Timepoint,length=3)
shuffcontrols<-read.csv('controltimepoints.csv',header=T)
shuffcontrols$Colony=factor(shuffcontrols$Colony)
shuffcontrols$Species=factor(shuffcontrols$Species)
shuffcontrols$Timepoint=as.integer(shuffcontrols$Timepoint,length=3)

# have a look at the data to see data distribution for the change in proportion Durusdinium
ggplot(data=filter(shuff,shuff$Species!='M.cavernosa'),aes(y=PropD, x=PropD0))+
  geom_smooth(aes(colour=Species, linetype=factor(Timepoint)), method='glm',method.args = list(family = "quasibinomial"), alpha=0.1)+
  geom_point(aes(colour=Species, shape=factor(Timepoint)))+
  geom_abline(slope=1,intercept = 0,linetype='dotted')+
  theme_minimal()


shuffmod=glm(PropD~PropD0+Species*Timepoint,data=filter(shuff, shuff$Species!='M.cavernosa'), family='quasibinomial')
summary(shuffmod)
anova(shuffmod,test='F')

propD1=glm(PropD ~ PropD0+Timepoint*Species,
             data=filter(shuff, shuff$Species!='M.cavernosa'), family='quasibinomial')

eff1 <- effect(c('PropD0', 'Timepoint', 'Species'), propD1, 
              xlevels=list(PropD0=seq(0, 1, by=0.01)))

res <- droplevels(data.frame(eff1))
res$Species <- factor(res$Species, levels=c("O.faveolata", "S.siderea"))
res$Timepoint <- factor(res$Timepoint,levels=c('1','2','3'))
# Get AUC for fitted values, lower and upper confidence limits
auc1 <- aggregate(res[, c("fit", "lower", "upper")], 
                 by=list(Species=res$Species,Timepoint=res$Timepoint), 
                 FUN=function(x) (mean(x)-0.5)/0.5)

#now an intial prop d independent model for mcav
propD2=lm(PropD ~ Timepoint,data=filter(shuff, shuff$Species=='M.cavernosa'))

eff2 <- effect(c('Timepoint'), propD2)

res <- droplevels(data.frame(eff2))
res$Timepoint <- factor(res$Timepoint,levels=c('1','2','3'))
# Get AUC for fitted values, lower and upper confidence limits
auc2 <- aggregate(res[, c("fit", "lower", "upper")], 
                 by=list(Timepoint=res$Timepoint), 
                 FUN=function(x) (mean(x)))
auc2$Species=factor(rep('M.cavernosa'))
auc2$upper[3]<-1
aucall <- rbind(auc1, auc2)
aucall$Treatment<-rep('Bleached',9)

#controls<-speciesshuff[c(3,4,6),]
#controls$Timepoint<-rep('3',3)
aucall<-rbind(aucall,aucallcont)
aucall$Timepoint=factor(aucall$Timepoint, levels=c(0,1,2,3))
aucall$Species=factor(aucall$Species, levels=c('M.cavernosa','O.faveolata','S.siderea'))


propD1cont=glm(PropD ~ PropD0+Timepoint*Species,
             data=filter(shuffcontrols, shuffcontrols$Species!='M.cavernosa'), family='quasibinomial')

eff1cont <- effect(c('PropD0', 'Timepoint', 'Species'), propD1cont, 
              xlevels=list(PropD0=seq(0, 1, by=0.01)))

rescont <- droplevels(data.frame(eff1cont))
rescont$Species <- factor(rescont$Species, levels=c("O.faveolata", "S.siderea"))
rescont$Timepoint <- factor(rescont$Timepoint,levels=c('1','2','3'))
# Get AUC for fitted values, lower and upper confidence limits
auc1cont <- aggregate(rescont[, c("fit", "lower", "upper")], 
                 by=list(Species=rescont$Species,Timepoint=rescont$Timepoint), 
                 FUN=function(x) (mean(x)-0.5)/0.5)

#now an intial prop d independent model for mcav
propD2cont=lm(PropD ~ Timepoint,data=filter(shuffcontrols, shuffcontrols$Species=='M.cavernosa'))

eff2cont <- effect(c('Timepoint'), propD2cont)

rescont <- droplevels(data.frame(eff2cont))
rescont$Timepoint <- factor(rescont$Timepoint,levels=c('1','2','3'))
# Get AUC for fitted values, lower and upper confidence limits
auc2cont <- aggregate(rescont[, c("fit", "lower", "upper")], 
                 by=list(Timepoint=rescont$Timepoint), 
                 FUN=function(x) (mean(x)))
auc2cont$Species=factor(rep('M.cavernosa'))
aucallcont <- rbind(auc1cont, auc2cont)
aucallcont$Treatment<-rep('Control',9)

t0<-read.csv('t0.csv', header=T)
aucall<-rbind(aucall,t0)
aucall$Timepoint=factor(aucall$Timepoint, levels=c(0,1,2,3))
aucall$Species=factor(aucall$Species, levels=c('M.cavernosa','O.faveolata','S.siderea'))
aucall$Timepoint[19:24]<-0

#quote the shuffling metric for bleached cores of each species, 'S': mcav=0.92659842, ofav=0.93774140, ssid=0.75972420.
#for controls, mcav=0.0093, ofav=0.0169, ssid=-0.1698
##########
ofav=expression(paste(italic("O. faveolata")))
ssid=expression(paste(italic("S. siderea")))
mcav=expression(paste(italic("M. cavernosa")))

ggplot(aucall, aes(x = Timepoint, y = fit, group = Species)) +
  geom_errorbar(data=aucall, aes(ymin = lower, ymax = upper), 
                position = position_dodge(0.2), lwd = 0.2, width = 0.2) +
  geom_point(aes(color = Species, shape=Treatment),
             position = position_dodge(0.2), size = 2.5)+
  geom_hline(yintercept = 0, lwd = 0.1) +
  scale_x_discrete(labels=c('Pre heat stress','Post heat stress','1 month recovery','2 month recovery'))+
  theme_minimal(base_size = 13)%+replace%
   theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
         panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
 geom_line(data=filter(aucall,aucall$Treatment=='Bleached'),linetype='dashed',alpha=0.6,aes(colour=Species),position = position_dodge(0.2))+
  geom_line(data=filter(aucall,aucall$Treatment=='Control'),linetype='dotted',alpha=0.6,aes(colour=Species),position = position_dodge(0.2))+
  scale_colour_manual(values=c('deeppink2','darkorange1','darkturquoise'),labels=c(mcav,ofav,ssid), name='')+
  scale_shape_manual(values=c(16,17),name='')+
  coord_cartesian(clip='on', ylim=c(-1.0,1.0))+
  labs(y='Symbiont Shuffling',x='')+
  annotate(geom='text',x=0.85,y=0.3,label=gaindd,size=3.3)+
   annotate(geom='text',x=0.85,y=-0.3,label=lostd,size=3.3)+
  theme(legend.position = 'bottom',
        legend.box.spacing = unit(0,'pt'),legend.spacing=unit(0,'pt'), legend.text = element_text(size=9))+
  scale_y_continuous(expand=c(0,0.05))
#ggsave('3a.shuffling_cumulative.pdf',device='pdf',height=5,width=7)

###The predicted values are based of a model which controls for pre-heat stress proportion durusdinium (rather than proportion durusdinium at the previous timepoint). Making 'timepoint' an integer rather than a factor in the model also changed things. Would like to perform stats on the interaction effect on shuffling between timepoint and species, but unsure how since mcav fitted to a separate model. The '2-month recovery' points are very slightly differnet from those in the bleached Vs control shuffling plot, but this is indicative of shuffling at each timepoint being linked to each coral (rather than averaged within each species) for these predicted values, rather than a mistake in the code. 
```

### Figure 3b: O. faveolata and S.siderea corals that initially hosted background Durusdinium shuffled more quickly and more fully to Durusdinium than those with no initial Durusdinium, which shuffled less than M.cavernosa that contained no initial Durusdinium.

```{r, warning=F, message=F}
#now look at timing for switching and shuffling

shufflegroups<- filter(shuffletimes,shuffletimes$Treatment=='Manipulated')
shufflegroups$initiald<-paste(shufflegroups$PropD1)
shufflegroups<-filter(shufflegroups,shufflegroups$initiald!='NA')
shufflegroups$initiald[shufflegroups$Species=='M.cavernosa' & shufflegroups$PropD1==0]='MC0'
shufflegroups$initiald[shufflegroups$Species!='M.cavernosa' & shufflegroups$PropD1==0]='OFSS0'
shufflegroups$initiald[shufflegroups$Species!='M.cavernosa' & shufflegroups$PropD1>0]='OFSS0TO50'
shufflegroups$initiald[shufflegroups$Species!='M.cavernosa' & shufflegroups$PropD1>0.50]='OFSS50TO100'
shufflegroups$initiald=factor(shufflegroups$initiald, levels=c('MC0','OFSS0','OFSS0TO50','OFSS50TO100'))
shufflegroups<-filter(shufflegroups,shufflegroups$initiald!='NA')
shufflegroupssh<-shufflegroups[,-c(1,2,4,5,6,7,8,9,14,15,16,17)]
shufflegroupsshprop<-shufflegroups[,-c(1,2,4,5,6,7,8,9,10,11,12,13)]
shufflegroups<-shufflegroups[,-c(10:17)]
  
shuffmod4=glmer(PropD4~initiald+(1|Colony),data=shufflegroups, family='binomial')
summary(shuffmod4)
# prop d significantly higher after mcav switching compared to ofav/ssid switching p=0.02**

shuffmod5=glmer(PropD4~initiald+(1|Colony),data=filter(shufflegroups, shufflegroups$Species!='M.cavernosa'), family='binomial')
summary(shuffmod5)

shufflegroups= pivot_longer(data=shufflegroups, cols=starts_with('PropD'),
               names_to='Timepoint', names_prefix='PropD', values_to='PropD',
               values_drop_na=F)

shufflegroupssh<-pivot_longer(data=shufflegroupssh, cols=c(2:5), names_to = 'Timepoint',names_prefix = 'sh', values_to = 'sh', values_drop_na = F)
shufflegroupssh<-shufflegroupssh[,-c(2)]

shufflegroupsshprop<-shufflegroupsshprop[,-c(6)]
colnames(shufflegroupsshprop)[2]<-'sh1'
colnames(shufflegroupsshprop)[3]<-'sh2'
colnames(shufflegroupsshprop)[4]<-'sh3'
colnames(shufflegroupsshprop)[5]<-'sh4'
shufflegroupsshprop<-pivot_longer(data=shufflegroupsshprop,cols=c(2:5), names_to = 'Timepoint',names_prefix = 'sh',values_to = 'shprop',values_drop_na = F)


shufflegroupsall<-full_join(shufflegroups,shufflegroupssh,by=c('Core','Timepoint'))
shufflegroupsall<-full_join(shufflegroupsall,shufflegroupsshprop,by=c('Core','Timepoint'))
shufflegroupsall<-filter(shufflegroupsall,shufflegroupsall$PropD!='NA')

#confirm that ofav and ssid can reasonably be grouped together:
shufflegroupsall$Species<-as.factor(shufflegroupsall$Species)
shufflegroupsall$Timepoint<-as.factor(shufflegroupsall$Timepoint)
shufflegroupsall$Colony<-as.factor(shufflegroupsall$Colony)
ofavssidpropd<- lmer(PropD~Timepoint*initiald*Species+(1|Colony),data=filter(shufflegroups,shufflegroups$Species!='M.cavernosa'))
summary(ofavssidpropd)#no significant effcet of ofav vs ssid on prop d (p=0.45), nor of time-species interaction (p=0.33)

shufflegroupsall$Timepoint<-as.factor(shufflegroupsall$Timepoint)
MCswitchex=expression(paste( italic("M. cavernosa "),'with 0.0                             '))
OFSSswitchex=expression(paste( italic("O. faveolata & S. siderea "),'with 0.0  '))
OFSSshuffex1=expression(paste( italic("O. faveolata & S. siderea "),'with >0.0 ≤ 0.5  '))
OFSSshuffex2=expression(paste( italic("O. faveolata & S. siderea "),'with >0.5'))

shufflegroupsall$propSHd<-shufflegroupsall$shprop * shufflegroupsall$PropD

ggplot(shufflegroupsall, aes(x = Timepoint, y = PropD, group=initiald)) +
  geom_point(aes(colour=initiald, shape=initiald),
             position = position_jitterdodge(), alpha=0.5) +
  stat_summary(aes(colour=initiald, shape=initiald),fun.data='mean_se',
             position = position_dodge(0.2), size=0.7,show.legend =F) +
  scale_x_discrete(labels=c('Pre heat stress','Post heat stress','1 month recovery','2 month recovery'))+
  stat_summary(geom='line', aes(linetype=initiald, colour=initiald),position = position_dodge(0.2))+
  theme_minimal(base_size = 13)%+replace%
   theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
         panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
  scale_linetype_manual(values=c('solid','dashed','dashed','dashed'),labels=c(MCswitchex,OFSSswitchex,OFSSshuffex1, OFSSshuffex2), name='Initial proportion *Durusdinium* groups')+
  scale_shape_manual(values=c(19,1,1,1),labels=c(MCswitchex,OFSSswitchex,OFSSshuffex1, OFSSshuffex2), name='Initial proportion *Durusdinium* groups')+
  scale_colour_manual(values=c('blue3','blue3','purple','brown2'),labels=c(MCswitchex,OFSSswitchex,OFSSshuffex1, OFSSshuffex2),name='Initial proportion *Durusdinium* groups')+
  labs(y="Proportion *Durusdinium*", x='')+
  guides(colour=guide_legend(nrow=2, byrow=TRUE, title.position ='top',title.hjust = 0.5),linetype=guide_legend(nrow=2, byrow=TRUE, title.position ='top',title.hjust = 0.5))+
  theme(legend.position = 'bottom', legend.title=element_markdown(size=11),legend.text = element_text(size=9), axis.title.y = element_markdown(), axis.text.x=element_text(size=9))+
  theme(plot.margin=margin(0.5,1.1,0.5,0.5,"cm"))
 
#ggsave('3b.initial_durusdinium_shuffling.pdf',device='pdf',height=5,width=7)

ggplot(shufflegroupsall, aes(x = Timepoint, y = log10(shprop), group=initiald)) +
  geom_point(aes(colour=initiald, shape=initiald),
             position = position_jitterdodge(), alpha=0.5) +
  stat_summary(aes(colour=initiald, shape=initiald),fun.data='mean_se',
             position = position_dodge(0.2), size=0.7,show.legend =F) +
  scale_x_discrete(labels=c('Pre heat stress','Post heat stress','1 month recovery','2 month recovery'))+
  stat_summary(geom='line', aes(linetype=initiald, colour=initiald),position = position_dodge(0.2))+
  theme_minimal(base_size = 13)%+replace%
   theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
         panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
  scale_linetype_manual(values=c('solid','dashed','dashed','dashed'),labels=c(MCswitchex,OFSSswitchex,OFSSshuffex1, OFSSshuffex2), name='Initial proportion *Durusdinium* groups')+
  scale_shape_manual(values=c(19,1,1,1),labels=c(MCswitchex,OFSSswitchex,OFSSshuffex1, OFSSshuffex2), name='Initial proportion *Durusdinium* groups')+
  scale_colour_manual(values=c('blue3','blue3','purple','brown2'),labels=c(MCswitchex,OFSSswitchex,OFSSshuffex1, OFSSshuffex2),name='Initial proportion *Durusdinium* groups')+
  labs(y="log (Proportional symbiont gain/loss)", x='')+
  guides(colour=guide_legend(nrow=2, byrow=TRUE, title.position ='top',title.hjust = 0.5),linetype=guide_legend(nrow=2, byrow=TRUE, title.position ='top',title.hjust = 0.5))+
  theme(legend.position = 'bottom', legend.title=element_markdown(size=11),legend.text = element_text(size=9), axis.title.y = element_text(size=9), axis.text.x=element_text(size=9))+
  theme(plot.margin=margin(0.5,1.1,0.5,0.5,"cm"))+
  geom_hline(yintercept = 0, lwd = 0.1) 
#ggsave('3c.initial_durusdinium_sh.pdf',device='pdf',height=5,width=7)


ggplot(shufflegroupsall, aes(x = Timepoint, y = log10(propSHd), group=initiald)) +
  geom_point(aes(colour=initiald, shape=initiald),
             position = position_jitterdodge(), alpha=0.5) +
  stat_summary(aes(colour=initiald, shape=initiald),fun.data='mean_se',
             position = position_dodge(0.2), size=0.7,show.legend =F) +
  scale_x_discrete(labels=c('Pre heat stress','Post heat stress','1 month recovery','2 month recovery'))+
  stat_summary(geom='line', aes(linetype=initiald, colour=initiald),position = position_dodge(0.2))+
  theme_minimal(base_size = 13)%+replace%
   theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
         panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
  scale_linetype_manual(values=c('solid','dashed','dashed','dashed'),labels=c(MCswitchex,OFSSswitchex,OFSSshuffex1, OFSSshuffex2), name='Initial proportion *Durusdinium* groups')+
  scale_shape_manual(values=c(19,1,1,1),labels=c(MCswitchex,OFSSswitchex,OFSSshuffex1, OFSSshuffex2), name='Initial proportion *Durusdinium* groups')+
  scale_colour_manual(values=c('blue3','blue3','purple','brown2'),labels=c(MCswitchex,OFSSswitchex,OFSSshuffex1, OFSSshuffex2),name='Initial proportion *Durusdinium* groups')+
  labs(y="log (Proportional Durusdinium gain/loss)", x='')+
  guides(colour=guide_legend(nrow=2, byrow=TRUE, title.position ='top',title.hjust = 0.5),linetype=guide_legend(nrow=2, byrow=TRUE, title.position ='top',title.hjust = 0.5))+
  theme(legend.position = 'bottom', legend.title=element_markdown(size=11),legend.text = element_text(size=9), axis.title.y = element_text(size=9), axis.text.x=element_text(size=9))+
  theme(plot.margin=margin(0.5,1.1,0.5,0.5,"cm"))+
  geom_hline(yintercept = 0, lwd = 0.1) 
#ggsave('3c.initial_durusdinium_sh.pdf',device='pdf',height=5,width=7)


#let's split the proportional s:h and th prop d into two panels; 'Threshold effect of initial proportion Durusdinium on recovery of cores with D' and 'Species differences in the ability of corals to become dominated by D when D is undetectable'.

panel1<-filter(shufflegroupsall, shufflegroupsall$initiald!='MC0')
panel2<-filter(shufflegroupsall, shufflegroupsall$initiald=='OFSS0'|shufflegroupsall$initiald=='MC0')

ggplot(panel1, aes(x = Timepoint, y = PropD, group=initiald)) +
  geom_point(aes(colour=initiald),shape=1,
             position = position_jitterdodge(), alpha=0.5) +
  stat_summary(aes(colour=initiald),shape=1,fun.data='mean_se',
             position = position_dodge(0.2), size=0.7,show.legend =F) +
  scale_x_discrete(labels=c('Pre heat stress','Post heat stress','1 month recovery','2 month recovery'))+
  stat_summary(geom='line', aes(colour=initiald),linetype='dashed',position = position_dodge(0.2))+
  theme_minimal(base_size = 13)%+replace%
   theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
         panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
  scale_colour_manual(values=c('blue3','purple','brown2'),labels=c('0.0','>0.0 ≤ 0.5', '>0.5'),name='*O. faveolata* & *S. siderea* initial proportion *Durusdinium* thresholds')+
  labs(y="Proportion *Durusdinium*", x='')+
  guides(colour=guide_legend(nrow=1, byrow=TRUE, title.position ='top'))+
  theme(legend.position = 'bottom', legend.title=element_markdown(size=11),legend.text = element_text(size=10), axis.title.y = element_markdown(), axis.text.x=element_text(size=10))+
  theme(plot.margin=margin(0.5,1.1,0.5,0.5,"cm"))
#ggsave('3b.initial_durusdinium_shuffling.pdf',device='pdf',height=5,width=7)

ggplot(panel2, aes(x = Timepoint, y = PropD, group=Species)) +
  geom_point(aes(colour=Species),shape=1,
             position = position_jitterdodge(), alpha=0.5) +
  stat_summary(aes(colour=Species),shape=1,fun.data='mean_se',
             position = position_dodge(0.2), size=0.7,show.legend =F) +
  scale_x_discrete(labels=c('Pre heat stress','Post heat stress','1 month recovery','2 month recovery'))+
  stat_summary(geom='line', aes(colour=Species),linetype='dashed',position = position_dodge(0.2))+
  theme_minimal(base_size = 13)%+replace%
   theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
         panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
  scale_colour_manual(values=c('deeppink2','darkorange1','darkturquoise'),labels=c(mcav,ofav,ssid),name='No pre-heat stress *Durusdinium* detected')+
  labs(y="Proportion *Durusdinium*", x='')+
  guides(colour=guide_legend(nrow=1, byrow=TRUE, title.position ='top'))+
  theme(legend.position = 'bottom', legend.title=element_markdown(size=11),legend.text = element_text(size=10), axis.title.y = element_markdown(), axis.text.x=element_text(size=10))+
  theme(plot.margin=margin(0.5,1.1,0.5,0.5,"cm"))
#ggsave('3c.initial_durusdinium_switching.pdf',device='pdf',height=5,width=7)


ggplot(panel1, aes(x = Timepoint, y = log10(shprop), group=initiald)) +
  geom_point(aes(colour=initiald),shape=1,
             position = position_jitterdodge(), alpha=0.5) +
  stat_summary(aes(colour=initiald),shape=1,fun.data='mean_se',
             position = position_dodge(0.2), size=0.7,show.legend =F) +
  scale_x_discrete(labels=c('Pre heat stress','Post heat stress','1 month recovery','2 month recovery'))+
  stat_summary(geom='line', aes(colour=initiald),linetype='dashed',position = position_dodge(0.2))+
  theme_minimal(base_size = 13)%+replace%
   theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
         panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
  scale_colour_manual(values=c('blue3','purple','brown2'),labels=c('0.0','>0.0 ≤ 0.5', '>0.5'),name='*O. faveolata* & *S. siderea* initial proportion *Durusdinium* thresholds')+
  labs(y="log (Proportional symbiont gain/loss)", x='')+
  guides(colour=guide_legend(nrow=1, byrow=TRUE, title.position ='top'))+
  theme(legend.position = 'bottom', legend.title=element_markdown(size=11),legend.text = element_text(size=10), axis.title.y = element_markdown(), axis.text.x=element_text(size=10))+
  theme(plot.margin=margin(0.5,1.1,0.5,0.5,"cm"))
#ggsave('S2a.initial_durusdinium_shufflingSH.pdf',device='pdf',height=5,width=7)

ggplot(panel2, aes(x = Timepoint, y = log10(shprop), group=Species)) +
  geom_point(aes(colour=Species),shape=1,
             position = position_jitterdodge(), alpha=0.5) +
  stat_summary(aes(colour=Species),shape=1,fun.data='mean_se',
             position = position_dodge(0.2), size=0.7,show.legend =F) +
  scale_x_discrete(labels=c('Pre heat stress','Post heat stress','1 month recovery','2 month recovery'))+
  stat_summary(geom='line', aes(colour=Species),linetype='dashed',position = position_dodge(0.2))+
  theme_minimal(base_size = 13)%+replace%
   theme(panel.border = element_rect(colour='grey20',fill=NA),
          panel.grid.minor.x = element_blank(),
         panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())+
  scale_colour_manual(values=c('deeppink2','darkorange1','darkturquoise'),labels=c(mcav,ofav,ssid),name='No pre-heat stress *Durusdinium* detected')+
  labs(y="log (Proportional symbiont gain/loss)", x='')+
  guides(colour=guide_legend(nrow=1, byrow=TRUE, title.position ='top'))+
  theme(legend.position = 'bottom', legend.title=element_markdown(size=11),legend.text = element_text(size=10), axis.title.y = element_markdown(), axis.text.x=element_text(size=10))+
  theme(plot.margin=margin(0.5,1.1,0.5,0.5,"cm"))
#ggsave('S2b.initial_durusdinium_switchingSH.pdf',device='pdf',height=5,width=7)

###Due to small sample size, ofav and ssid are grouped together here (model finds no significant effect of species). Now this plot includes all corals. 
   
```